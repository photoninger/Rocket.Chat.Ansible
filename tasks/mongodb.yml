---
# tasks/mongodb.yml: MongoDB configuration for RocketChat.Ansible

  - name: Older Debian/Ubuntu mongodb tasks
    block:

    - name: Ensure the MongoDB repository key has been imported
      apt_key:
        keyserver: "{{ rocket_chat_mongodb_keyserver }}"
        id: "{{ rocket_chat_mongodb_gpg_key }}"
      tags: repo

    - name: Ensure the MongoDB repository is present
      apt_repository:
        repo: "{{ rocket_chat_mongodb_apt_repo }}"
        state: present
      tags: repo

    when:
      - rocket_chat_mongodb_apt_repo is defined
      - ansible_os_family == "Debian"

  - name: Ensure MongoDB Server is present
    package:
      name: "{{ rocket_chat_mongodb_packages }}"
      state: present

  - name: Deploy MongoDB service configuration
    template:
      src: "{{ rocket_chat_mongodb_config_template }}"
      dest: /etc/mongod.conf
    notify: Restart the MongoDB service

  - meta: flush_handlers

  - name: Ensure the MongoDB service is started/enabled
    service:
      name: mongod
      state: started
      enabled: yes
